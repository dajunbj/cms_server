<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cms.module.ocr.mapper.ReceiptInfoMapper">

	<insert id="insert"
		parameterType="com.cms.module.ocr.entity.ReceiptInfo">
		INSERT INTO receipt_info (
		image_path, store_name,
		issue_date, amount, full_text, user_id, status,
		created_at
		) VALUES (
		#{imagePath}, #{storeName}, #{issueDate}, #{amount}, #{fullText},
		#{userId}, #{status}, #{createdAt}
		)
	</insert>

	<select id="queryByCondition"
		resultType="com.cms.module.ocr.dto.ReceiptInfoListItem">
		SELECT
		id,
		image_path AS imagePath,
		store_name AS storeName,
		issue_date AS
		issueDate,   <!-- 不要 DATE_FORMAT -->
		amount AS amount,      <!-- 不要 FORMAT -->
		status,
		created_at AS createdAt
		FROM receipt_info
		<where>
			<if test="cond.storeName != null and cond.storeName != ''">
				AND store_name LIKE CONCAT('%', #{cond.storeName}, '%')
			</if>
			<if test="cond.status != null and cond.status != ''">
				AND status = #{cond.status}
			</if>
		</where>
		ORDER BY created_at DESC
		LIMIT #{cond.limit} OFFSET #{cond.offset}
	</select>


	<select id="countByCondition" resultType="int">
		SELECT COUNT(*)
		FROM receipt_info
		<where>
			<if test="cond.storeName != null and cond.storeName != ''">
				AND store_name LIKE CONCAT('%', #{cond.storeName}, '%')
			</if>
			<if test="cond.status != null and cond.status != ''">
				AND status = #{cond.status}
			</if>
		</where>
	</select>

	<update id="updateStatusAppliedBatch">
		UPDATE receipt_info
		SET status = '申請済'
		WHERE id IN
		<foreach collection="ids" item="id" open="(" separator=","
			close=")">
			#{id}
		</foreach>
		AND status IN ('草稿','確認済')
	</update>

	<select id="countNotApplyable" resultType="int">
		SELECT COUNT(*)
		FROM receipt_info
		WHERE id IN
		<foreach collection="ids" item="id" open="(" separator=","
			close=")">
			#{id}
		</foreach>
		AND status NOT IN ('草稿','確認済')
	</select>


</mapper>
